import fiji.plugin.trackmate.Spot;
import fiji.plugin.trackmate.detection.DetectionUtils;
import fiji.plugin.trackmate.detection.DogDetector;
import fiji.plugin.trackmate.detection.LogDetector;
import fiji.plugin.trackmate.util.TMUtils;
import fiji.plugin.trackmate.Model;
import fiji.plugin.trackmate.Settings;
import fiji.plugin.trackmate.detection.LogDetectorFactory;
import fiji.plugin.trackmate.features.FeatureFilter;
import fiji.plugin.trackmate.TrackMate;
import ij.IJ;
import ij.ImagePlus;
import ij.measure.Calibration;
import ij.plugin.ZProjector;
import fiji.plugin.trackmate.visualization.hyperstack.HyperStackDisplayer;
import fiji.plugin.trackmate.SelectionModel;
import fiji.plugin.trackmate.SpotCollection;
import com.google.common.collect.Iterables;

IJ.open("/home/tong/Documents/movies/102-s2/movie_X0_Y0_FLUO/croppedImgs/1_CFP.tif");
//ImagePlus imp = IJ.openImage("D:/Data/Tong/Movies/0_FLUO/MMStack_Pos0.ome.tif");
//IJ.openImage("/Users/theoli89/Desktop/curioData/single_field/102_4/movie_X0_Y0_FLUO/15/MMStack_Pos0.ome.tif");

ImagePlus imp =IJ.getImage();
ZProjector projector = new ZProjector();
projector.setMethod(ZProjector.MAX_METHOD);
projector.setImage(imp);
projector.doProjection();

ImagePlus zprojection = projector.getProjection();
zprojection.show();
Calibration cal = imp.getCalibration();
Model model = new Model();

Settings settings = new Settings();

settings.setFrom(zprojection);

settings.detectorFactory = new LogDetectorFactory();
Map detectorSettings = new HashMap();
detectorSettings.put("DO_SUBPIXEL_LOCALIZATION", true);
detectorSettings.put("RADIUS", (double) 5);
detectorSettings.put("TARGET_CHANNEL", 1);
detectorSettings.put("THRESHOLD", (double) 0);
detectorSettings.put("DO_MEDIAN_FILTERING", false);
settings.detectorSettings = detectorSettings;

FeatureFilter filter1 = new FeatureFilter("QUALITY", 1, true);
settings.addSpotFilter(filter1);

TrackMate trackmate = new TrackMate(model, settings);
print("Trackmate created");

trackmate.execDetection();
print("execDetection done");

trackmate.execInitialSpotFiltering();
print("execInitialSpotFiltering done");

trackmate.computeSpotFeatures(true);
print("computeSpotFeatures done");

trackmate.execSpotFiltering(true);
print("execSpotFiltering done");

print("Found " + trackmate.getModel().getSpots().getNSpots(true) + " spots");
SpotCollection spots = trackmate.getModel().getSpots();
//print(Iterables.size(spots.iterable(true)));
for(Spot spot : spots.iterator(true)) {
	print(spot.getFeature(Spot.FRAME));
	print(Iterables.size(spots.iterable(0, true)));
	print(spots.remove(spot, 0));
}
//print(Iterables.size(spots.iterable(false)));
//spots.clear();
//print(Iterables.size(spots.iterable(false)));

//model.setSpots(spots, false);
// Show
SelectionModel selectionModel = new SelectionModel(model);
HyperStackDisplayer displayer= new HyperStackDisplayer(model, selectionModel, zprojection);
displayer.render();
displayer.refresh();