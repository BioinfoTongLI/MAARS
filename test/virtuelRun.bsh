//base_dir = "D:/Data/Tong/MAARS/";
base_dir = "/home/tong/Documents/code/MAARS/";
//base_dir = "/home/hadim/Documents/phd/dev/MAARS/";
//base_dir = "/Volumes/Macintosh/Documents/MAARS/";

addClassPath(base_dir + "target/MAARS_-1.0.jar");
//dep_base_dir = "/home/tong/.m2/repository/";
//dep_base_dir = "/Users/tongli/.m2/repository/";
//dep_base_dir = "C:\\Users\\NIKON\\.m2\\repository\\";
//addClassPath(dep_base_dir +"sc/fiji/TrackMate_/TrackMate_-2.8.1.jar");
//addClassPath(dep_base_dir +"org/scijava/scijava-common/2.38.2/scijava-common-2.38.2.jar");
//addClassPath(dep_base_dir +"net/imglib2/imglib2/2.4.0/imglib2-2.4.0.jar");
//addClassPath(dep_base_dir +"net/imglib2/imglib2-algorithm/0.3.2/imglib2-algorithm-0.3.2.jar");
//addClassPath(dep_base_dir +"net/imglib2/imglib2-ij/2.0.0-beta-31/imglib2-ij-2.0.0-beta-31.jar");
//addClassPath(dep_base_dir +"net/imglib2/imglib2-algorithm-fft/0.1.2/imglib2-algorithm-fft-0.1.2.jar");
//addClassPath(dep_base_dir +"net/imglib2/imglib2-algorithm-gpl/0.1.5/imglib2-algorithm-gpl-0.1.5.jar");
//addClassPath(dep_base_dir +"net/imagej/imagej-common/0.12.2/imagej-common-0.12.2.jar");
//addClassPath(dep_base_dir +"net/sf/jgrapht/jgrapht/0.8.3/jgrapht-0.8.3.jar");
//addClassPath(dep_base_dir +"edu/mines/mines-jtk/20100113/mines-jtk-20100113.jar");
//addClassPath(dep_base_dir +"gov/nist/math/jama/1.0.3/jama-1.0.3.jar");

//reloadClasses();

import java.util.List;
import fiji.plugin.maars.utils.FileUtils;
import fiji.plugin.maars.maarslib.*;
import fiji.plugin.maars.maarslib.MaarsMainDialog;
import fiji.plugin.maars.maarslib.MaarsParameters;
import fiji.plugin.maars.maarslib.ExplorationXYPositions;
import mmcorej.CMMCore;
import org.micromanager.*;
import ij.*;
import java.io.IOException;
import java.util.HashMap;
import fiji.plugin.maars.cellstateanalysis.Cell;
import ij.ImagePlus;


double calibration = mm.core().getPixelSizeUm();
//mmc.setAutoShutter(false);

print("Create main window");
MaarsMainDialog md = null;

md = new MaarsMainDialog(mm, mmc, base_dir + "maars_config.xml");

print("Show main window");

md.show();

while(!md.isOkClicked()) {
	Thread.sleep(1000);
}

if(md.isOkClicked()) {
	start = System.currentTimeMillis();
	print("start "+start);
	MaarsParameters param = null;

	print("AutoFocusing...");
	autofocus = mm.getAutofocus();
	print("Getting parameters...");
	param = md.getParameters();

	int nbXField = param.getFieldNb(MaarsParameters.X_FIELD_NUMBER);
	int nbYField = param.getFieldNb(MaarsParameters.Y_FIELD_NUMBER);
	
	print("nb x field "+nbXField+" nb y field "+nbYField);

	if (nbXField * nbYField != 0){
	ExplorationXYPositions explo = new ExplorationXYPositions(nbXField,
													nbYField,
													(double) mmc.getImageWidth()*calibration,
													(double) mmc.getImageHeight()*calibration);

	ImagePlus fluoImage = null;
	for (int i = 0; i < explo.length(); i++) {
		print("x : "+explo.getX(i)+" y : "+explo.getY(i));
		double xPos = explo.getX(i);
		double yPos = explo.getY(i);

		MaarsSegmentation ms = new MaarsSegmentation(param,
				xPos,
				yPos);
		ms.segmentation();
		print("Roi detected");
		if (ms.roiDetected()){
			String fluoFolder = FileUtils.convertPath(param
													.getSavingPath()
													+ "/movie_X"
													+ Math.round(xPos)
													+ "_Y"
													+ Math.round(yPos) +"_FLUO");
			MaarsFluoAnalysis mfa = new MaarsFluoAnalysis(param, ms.getSegPombeParam(), xPos, yPos);
			MaarsAcquisitionForFluoAnalysis mafa = new MaarsAcquisitionForFluoAnalysis(md,
															xPos,
															yPos,
															mfa.getSetOfCells());
		int frame = 0;

		while(frame<2){
			print("fluo analysing");
			String channels = param.getUsingChannels();
			String[] arrayChannels = channels.split(",", -1);
			for (String channel:arrayChannels) {
				String acqNameFluo = acqNameFluo + "/" + frame + "_" + channel;
				fluoImage = IJ.openImage(fluoFolder + "/"
					+frame+ "_" + channel +"/MMStack.ome.tif");
				print(channel);
				mfa.setFluoImage(fluoImage);
				mfa.createCellChannelFactory(channel);
				mfa.setCurrentFrame(frame);
				mfa.zProject();
				mfa.cropAllCells();
				mfa.analyzeEachCell();

			}
			// close roi manager
			mfa.getSetOfCells().closeRoiManager();
			frame++;
			acqNameFluo = null;
			fluoImage = null;
		}
		if (Boolean.parseBoolean(
			param.getFluoParameter(
				MaarsParameters.SAVE_FLUORESCENT_MOVIES))) {
				mfa.saveCroppedImgs();
			}
		ms = null;
		}
		print("end "+System.currentTimeMillis());
		print("it took "+(System.currentTimeMillis()-start));
		print("DONE.");
	}

	}else{
		print("Session aborted, 0 field to analyse");
	}
	}else{
		print("Session aborted, click 'OK' to start analyse.");
}
