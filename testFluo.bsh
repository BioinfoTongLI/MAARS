//base_dir = "C:/Program Files/Micro-Manager-1.4/jars/";
//base_dir = "/home/tong/Documents/code/MAARS/";
base_dir = "/Users/theoli89/Documents/MAARS/";
//base_dir = "/home/hadim/Documents/phd/dev/MAARS/";

addClassPath(base_dir + "MaarsLib/target/MaarsLib-1.0.jar");
addClassPath(base_dir + "CellsBoundaries/target/CellsBoundaries-1.0.jar");
addClassPath(base_dir + "CellStateAnalysis/target/CellStateAnalysis-1.0.jar");

import fiji.plugin.maars.maarslib.*;
import fiji.plugin.maars.maarslib.MaarsMainDialog;
import fiji.plugin.maars.maarslib.AllMaarsParameters;
import fiji.plugin.maars.maarslib.ExplorationXYPositions;
import fiji.plugin.maars.cellstateanalysis.SetOfCells;
import mmcorej.*;
import org.micromanager.api.*;
import ij.*;
import java.io.IOException;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import java.util.HashMap;

double calibration = gui.getMMCore().getPixelSizeUm();
mmc.setAutoShutter(false);
mmc.waitForDevice(mmc.getShutterDevice());

gui.message("Create main window");
MaarsMainDialog md = null;
try {
	md = new MaarsMainDialog(gui, mmc, base_dir + "MaarsLib/");
} catch (IOException e) {
	gui.message("Error");
}

gui.message("Show main window");

md.show();

while(md.isVisible()) {
	gui.sleep(1000);
}

if(md.isOkClicked()) {
	start = System.currentTimeMillis();
	gui.message("start "+start);
	AllMaarsParameters param = null;
	autofocus = gui.getAutofocus();
	param = md.getParameters();
	mmc.setOriginXY(mmc.getXYStageDevice());
	int nbXField = param
						.getParametersAsJsonObject()
						.get(AllMaarsParameters.EXPLORATION_PARAMETERS)
						.getAsJsonObject()
						.get(AllMaarsParameters.X_FIELD_NUMBER)
						.getAsInt();
	int nbYField = param
						.getParametersAsJsonObject()
						.get(AllMaarsParameters.EXPLORATION_PARAMETERS)
						.getAsJsonObject()
						.get(AllMaarsParameters.Y_FIELD_NUMBER)
						.getAsInt();
	
	gui.message("nb x field "+nbXField+" nb y field "+nbYField);

	if (nbXField * nbYField != 0){
		ExplorationXYPositions explo = new ExplorationXYPositions(nbXField,
													nbYField,
													(double) mmc.getImageWidth()*calibration,
													(double) mmc.getImageHeight()*calibration);
		MaarsAcquisitionForSegmentation mas = new MaarsAcquisitionForSegmentation(md,
				0,
				0);

		HashMap params = mas.getParametersFromConf(param);
		params.put("shutter","DShutter");
		mas.setParameters(params);
		
		String pathToRootDir = param.getParametersAsJsonObject()
				.get(AllMaarsParameters.MITOSIS_MOVIE_PARAMETERS)
				.getAsJsonObject().get(AllMaarsParameters.SAVING_PATH)
				.getAsString();
		//pathToRootDir = "/home/hadim/Documents/phd/data/maars/";
		//pathToRootDir = "/home/tong/Documents/Movies/";
		pathToRootDir = "/Users/theoli89/Desktop/Movies/";
		
		String pathToFluoImg = pathToRootDir;

		String pathToBf = pathToRootDir +"best/movie_X0_Y0/rescaled_DUP_Segment_MMStack_Pos0.ome_FocusImage.tif";
		ImagePlus bfImg = IJ.openImage(pathToBf);
		
		String pathToCorrImg = pathToRootDir +"best/movie_X0_Y0/rescaled_DUP_Segment_MMStack_Pos0.ome_CorrelationImage.tif";
		ImagePlus corrImg = IJ.openImage(pathToCorrImg);

		String pathToFluoImg = pathToRootDir +"best/movie_X0_Y0/rescaled_DUP_Segment_MMStack_Pos0.ome_FLUO.tif";
		ImagePlus fluoImage = IJ.openImage(pathToFluoImg);

		String pathToRoiZip = pathToRootDir + "best/movie_X0_Y0/rescaled_DUP_Segment_MMStack_Pos0.ome_ROI.zip";

		int focusSlice = 16; // =33/2
		
		//SetOfCells soc = new SetOfCells(bfImg, corrImg, focus, direction, pathToRoiZip, savePath);
		SetOfCells soc = new SetOfCells(bfImg, corrImg, focusSlice, -1, pathToRoiZip, pathToRootDir);
		MaarsFluoAnalysis mfa = new MaarsFluoAnalysis(param, soc);
		MaarsAcquisitionMitosis mmad = new MaarsAcquisitionMitosis(md, mfa, 0, 0);

		mfa.getSetOfCells().shuffle();

		MaarsAcquisitionForFluoAnalysis mafa = new MaarsAcquisitionForFluoAnalysis(md,
														0,
														0,
														soc);

		if(param
				.getParametersAsJsonObject()
				.get(AllMaarsParameters.FLUO_ANALYSIS_PARAMETERS)
				.getAsJsonObject()
				.get(AllMaarsParameters.FIND_BEST_MITOSIS_IN_FIELD)
				.getAsBoolean()) {

			int cellNumber = mfa.analyzeEntireField(fluoImage, pathToRootDir +"best/movie_X0_Y0/rescaled_DUP_Segment_MMStack_Pos0.ome");
			if (cellNumber != -1) {
				mmad.acquire(false, cellNumber, true, true);
			}
		}else {
			int j = 0;
			boolean mitosis = false;
			while(j <  mfa.getSetOfCells().length() && !mitosis) {
				ImagePlus fluoImage = mafa.acquire(false, j);
				fluoImage.show();
				if (mfa.checkStartConditions(mfa.getSpindle(fluoImage, j))) {
					gui.message("mitosis");
					mmad.acquire(true, j, false,true); //don't crop image because it is already cropped
					mitosis = true;
				}
				j++;
			}
		}
		// close roi manager
		mfa.getSetOfCells().closeRoiManager();
		mas.setParameters(params);
	}

	mmc.setAutoShutter(true);
	mmc.waitForDevice(mmc.getShutterDevice());
	gui.message("end "+System.currentTimeMillis());
	gui.message("it took "+(System.currentTimeMillis()-start));
	gui.message("DONE.");
	}else{
		gui.message("Session aborted, 0 field to analyse");
	}
